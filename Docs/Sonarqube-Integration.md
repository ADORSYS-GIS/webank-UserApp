# SonarQube Integration Guide for Project Code Quality and Security Analysis

This guide covers the setup, configuration, and usage of SonarQube to analyze code quality, detect bugs, and identify security vulnerabilities in your project. The document includes instructions for both local and organization-hosted SonarQube server setups, as well as CI/CD integration with GitHub Actions.

## Contents
1. [Overview](#1-overview)
2. [Prerequisites](#2-prerequisites)
3. [SonarQube Installation Options](#3-sonarqube-installation-options)
4. [Project Configuration](#4-react-project-configuration)
5. [Running SonarQube Analysis Locally](#5-running-sonarqube-analysis-locally)
6. [GitHub Actions CI/CD Integration](#6-github-actions-cicd-integration)
7. [Advanced Configuration Options](#7-troubleshooting-common-issues)
8. [Conclusion](#8-conclusion)

## 1. Overview

SonarQube is a continuous code quality inspection tool that provides in-depth analysis of code quality, detects security vulnerabilities, and ensures code reliability through Quality Gates. Quality Gates enforce specific standards (e.g., 0 critical bugs, test coverage of at least 80%) that code must pass before merging or deploying.
Adhering to standard best practices ensures code readability, maintainability, and overall software quality. However, identifying and addressing code quality issues manually can be time-consuming and error-prone. This is where tools like SonarCloud come into play, providing automated code analysis and static code reviews to help developers identify and resolve potential issues early on.

## 2. Prerequisites

- Docker (for local SonarQube setup)
- Node.js and npm (for JavaScript-based projects)
- SonarScanner CLI or SonarQube plugin in your preferred IDE
- GitHub Repository (for CI/CD integration example)
- Ensure your code has unit tests and generates a coverage report (e.g., lcov.info) for SonarQube to read and analyze.

## 3. SonarQube Installation Options

### Using an Organization-Hosted SonarQube Server

If your organization provides a hosted SonarQube server, you can connect directly to it:

1. Log into the Hosted Server:
    - Access the URL provided by your organization (e.g., https://sonarqube.companydomain.com).
    - Use your organization credentials to log in.

    * ![reference image](/Docs/sonarqube-images/log.png)

2. Create a Project in SonarQube:
    - Go to Projects > Create Project.

    - Provide a unique Project Key and Display Name.

    * ![reference image](/Docs/sonarqube-images/proj.png)

    - Complete the project creation wizard.

3. Generate a SonarQube Token:
4.
    - Go to My Account > Security > Generate Token.
    - Copy the token for later use in CI/CD and local analysis.

Alternatively,you can also install SonarQube locally using Docker.

### Local Installation with Docker

1. Run SonarQube with Docker:
   ```bash
   docker pull sonarqube
   docker run -d --name sonarqube -p 9000:9000 sonarqube

2. Access SonarQube
- Open a browser and navigate to http://localhost:9000.
- Default login: admin / admin.

3. Change Default Password:
- Go to My Account > Security and change the admin password for security.


## 4. React Project Configuration

To configure SonarQube analysis for your React project,
- Start by installing Sonar-Scanner dependency using npm:
- ```bash 
  npm install sonar-scanner --save-dev
  ```
- Create a `sonar-project.properties` file in the root of your React project.This file is a configuration file for SonarQube that specifies the analysis parameters for a project. It defines the necessary settings SonarQube needs to locate, analyze, and report on the project’s code.
### sonar-project.properties Example:

```properties
sonar.projectKey=webank-Userapp(you can use your own project key)
sonar.projectName=webank-Userapp(you can use your own project name)
sonar.host.url=https://sonarqube.companydomain.com( Use organization's URL if hosted) or http://localhost:9000(Use docker local sonarqube server)
sonar.sources=src
sonar.javascript.lcov.reportPaths=coverage/lcov.info
sonar.exclusions= **/*.test.jsx,**/*.css, src/reportWebVitals.js, src/index.js

```
### Explanation of properties
- **sonar.projectKey:** Specifies the unique identifier for the SonarQube project. This key is used to differentiate this project from others in SonarQube.
- **sonar.host.url:** SonarQube server URL (use your organization’s URL if hosted).
- **sonar.source:** Specifies the path to the source code files to be analyzed. In this case, the source code is located in the "src" directory.
- **sonar.javascript.lcov.reportPaths:** Specifies the path to the coverage report file generated by a test coverage tool like Istanbul. In this case, the coverage report is located at "coverage/lcov.info". SonarQube can utilize this coverage report to provide insights into code coverage and identify areas of the code that lack proper testing.
- **sonar.exclusions:** Specifies a list of file patterns to exclude from analysis. In this case, we exclude test files, CSS files, and a specific file named "reportWebVitals.js" from analysis.

Next, let’s edit the test script on our package.json so the React will have a coverage folder to be reported on sonarqube(in our case, we are using vitest so add a --coverage tag!):

```json
"scripts": {
  --------
  "test": "vitest --coverage"
  --------
}
```
Next, add the coverage folder to .gitignore so it won’t be pushed to the git repo:
# package directories .gitignore
..
node_modules
jspm_packages
coverage
..

## 5. Running SonarQube Analysis Locally

### Option A: Using an Organization-Hosted SonarQube Server
* If your organization hosts SonarQube, adjust the URL and token accordingly:*
1. Run the analysis with the SonarScanner CLI:
```bash
sonar-scanner -Dsonar.projectKey=webank-Userapp(use your own project key) 
-Dsonar.host.url=https://sonarqube.companydomain.com 
-Dsonar.login=your_sonarqube_token(use the token generated from SonarQube)

```

### Option B: With Local Docker SonarQube

1. Ensure the local Docker container is running on http://localhost:9000.

2. Run the analysis with the SonarScanner CLI:

   ```bash
   sonar-scanner -Dsonar.projectKey=my-awesome-app 
   -Dsonar.login=your_sonarqube_token
   
   ```
## 6. GitHub Actions CI/CD Integration
### GitHub Secrets
In your repository settings, add the SonarQube token as a secret:
To create secrets for a repository, you must be the repository owner or have admin access for organization repositories. Here are the steps to create a secret:

1. **Navigate to Your Repository**: On GitHub, go to the main page of your repository.
2. **Access Settings**: Under your repository name, click **Settings**.
3. **Select Secrets**: In the "Security" section of the sidebar, select **Secrets and variables**, then click **Actions**.
4. **Add New Secret**: Click on **New repository secret**.
5. **Enter Secret Details**:
    - In the **Name** field, type a name for your secret , Add `SONAR_TOKEN` with the generated token value.
    - In the **Secret** field, enter the value for your secret (the actual token).
6. **Save Secret**: Click **Add secret**.

### Using Secrets in Your Workflow

Once you have created your secrets, you can reference them in your GitHub Actions workflows using the syntax `${{ secrets.SECRET_NAME }}`. For example:

```yaml
env:
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
```

### GitHub Actions Workflow Example
Create a `.github/workflows/sonarqube-analysis.yml` file in your repository:

Automate code analysis by integrating SonarQube with GitHub Actions. This workflow will run SonarQube analysis on every push and pull request to the main branch.

```yaml
name: SonarQube Analysis

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  sonarQubeAnalysis:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm install

      - name: Run Tests and Generate Coverage Report
        run: npm run coverage

      - name: Run SonarQube Analysis
        uses: sonarsource/sonarqube-scan-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: |
            -Dsonar.projectKey=my-awesome-app
            -Dsonar.host.url=https://sonarqube.companydomain.com
            -Dsonar.sources=src
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

      - name: Quality Gate Check
        id: qualitygate
        uses: sonarsource/sonarqube-quality-gate-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Fail Workflow if Quality Gate Fails
        if: steps.qualitygate.outputs.status != 'PASSED'
        run: exit 1
```
### Workflow Jobs 
1. **Check out the code**: This step clones the code from your repository and fetches the latest changes.
2. **Install dependencies**: This step installs the project dependencies using `npm ci`.
3. **Run Tests and Generate Coverage Report**: This step runs tests and generates a coverage report using `npm run coverage`.
4. **Run SonarQube Analysis**: This step runs the SonarQube analysis using the SonarScanner CLI and the generated coverage report.
5. **Quality Gate Check**: This step checks the quality gate status using the SonarQube Quality Gate Action.
6. **Fail Workflow if Quality Gate Fails**: This step fails the workflow if the quality gate status is not "PASSED".


## 7. Troubleshooting Common Issues

1. **Invalid Project Key**: Ensure the project key in `sonar-project.properties` contains only allowed characters (-, _, ., :).

2. **Coverage Not Detected**: Verify the path specified in `sonar.javascript.lcov.reportPaths` is correct, and ensure coverage files are generated before SonarQube analysis.

3. **Failed Quality Gate Status in CI/CD**: Check the Quality Gate configuration in SonarQube to ensure conditions align with your project goals.

4. **Report not created**:if you're using vite, make sure you update your vitest.config.ts by adding lcov in the reporter field

## 8. Conclusion

This guide should provide you with a strong foundation to start using SonarQube in your development workflow, from initial setup to automating quality checks in CI/CD. SonarQube's powerful code analysis and customizable quality gates help maintain code integrity, reducing technical debt and preventing vulnerabilities from reaching production.